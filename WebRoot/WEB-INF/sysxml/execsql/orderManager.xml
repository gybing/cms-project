<?xml version="1.0" encoding="UTF-8"?>
<mappers xmlns="http://www.weimingfj.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://itest.56913.com:20080/xsd/mappers.xsd">
	<!-- 运单列表 -->
	<mapper id="queryOrderList">
		<sql key="queryOrderList" resultType="paging" operator="select">
			<isNotEmpty property="query_count">
				SELECT COUNT(DISTINCT T.ORDER_ID) 
			</isNotEmpty>
	        <isEmpty property="query_count">
        	  SELECT (@I:=@I+1) NUM,A.* FROM (
	        	 SELECT 
	        	   DISTINCT T.ORDER_ID,
	        	   IFNULL(T.IS_RESERVE,'0') IS_RESERVE,
			       (SELECT D.TEXT FROM dict_common D WHERE D.TYPE = 'INOTYPE' AND D.CODE = T.IN_OUT) INO,
			       T.IS_FINISH,
			       (SELECT D.TEXT FROM dict_common D WHERE D.TYPE = 'ORDERTYPE' AND D.CODE = T.IS_FINISH) ISFINISH,
			       T.ORDER_NO,
			       T.SHIPMENT_NO,
			       T.SHIP_NAME,
			       T.SHIP_VOYAGE,
			       DATE_FORMAT(T.SHIP_DATE, '%Y-%m-%d') SHIP_DATE,
			       T.CARGO_OWNNER,
		       	   (SELECT TRIM(O.SHORTCUT) FROM tab_box_ownner O WHERE O.OWNNER_ID=T.BOX_OWNNER_1 LIMIT 1) BOXOWNNER1,
			       T.ADDR,
			       (SELECT CONCAT(P.PORT_CODE,' ',P.PORT_CN) PORT_CN FROM tab_port P WHERE P.PORT_CODE=T.LOAD_PORT LIMIT 1) LOADPORT,
			       T.BOX_NUMS,
				   T.ALL_COST,
			       T.FEE_REMARK,				   
			       (SELECT CONCAT(C.PROVINCE,C.SIMPLE_CITY,C.TEXT) FROM base_area_tab C WHERE C.CODE=T.BOX_DRAG_AREA LIMIT 1) BOXDRAGAREA,
		       	   (SELECT A.NAME FROM dict_area A WHERE A.CODE=T.BOX_TAKE LIMIT 1) BOXTAKE,
		       	   (SELECT A.NAME FROM dict_area A WHERE A.CODE=T.BOX_RETURN LIMIT 1) BOXRETURN,
			       T.PAYER,
			       T.LOAD_CONTACT,
			       T.ORDER_REMARK,
			       (SELECT CONCAT(P.PORT_CODE,' ',P.PORT_CN) PORT_CN FROM tab_port P WHERE P.PORT_CODE=T.TO_PORT LIMIT 1) TOPORT
			       <!-- T.TAG,
		       	   DATE_FORMAT(T.ORDER_DATE, '%Y-%m-%d %H:%i') ORDER_DATE,
			       T.SCHEDULE_CENTER,
			       T.LOAD_WAY,
			       (SELECT D.TEXT FROM dict_common D WHERE D.TYPE = 'LOADWAY' AND D.CODE = T.LOAD_WAY) LOADWAY,
			       T.OWNNER_NAME,
			       T.OWNNER_TEL,
			       T.CARGO_PROXY_ID,
			       T.CARGO_PROXY,
			       T.PROXY_NAME,
			       T.PROXY_TEL,
			       T.BOX_OWNNER_2,
		       	   (SELECT TRIM(CONCAT(O.SHORTCUT,' ',O.LINKNAME)) FROM tab_box_ownner O WHERE O.OWNNER_ID=T.BOX_OWNNER_2 LIMIT 1) BOXOWNNER2,
			       T.BOX_DRAG,
			       T.CARGO_REMARK,
			       T.CARGO_NAME,
			       T.CARGO_NUM,
			       T.CARGO_WEIGHT,
			       T.CARGO_SIZE,
			       T.CARGO_TEMPRETURE,
			       T.CUSTOMS,
			       T.ORDER_PRINT,
			       T.SEAL_FROM,
			       T.SALESMAN,
			       T.TARIFF,
			       T.FEE_LIMITED,
			       T.WAIGUAN,
				   T.WEITUOBIANJIAN,
				   T.BIANJIANEDI,
				   T.FANGXIANG,
				   T.XUNZHENG,
				   T.SHENBEIDAN,
				   T.WAIXIE,
			       T.KEYWORD,
			       T.CREATE_USER_ID,
			       T.CREATE_USER,
			       DATE_FORMAT(T.CREATE_TIME, '%Y-%m-%d %T') CREATE_TIME,
			       T.OP_USER_ID,
			       T.OP_USER,
			       DATE_FORMAT(T.OP_TIME, '%Y-%m-%d %T') OP_TIME,
			       T.IS_DEL -->
	        </isEmpty>
	          FROM tab_order T LEFT JOIN tab_order_box B ON B.ORDER_ID=T.ORDER_ID
	           WHERE T.IS_DEL = 'N'
			 <isNotEmpty property="columns[0][search][value]">
	         	AND T.ORDER_NO LIKE '%${columns[0][search][value]}%'
	         </isNotEmpty>	         
			 <isNotEmpty property="columns[1][search][value]">
	         	AND T.BOX_OWNNER_1 = #{columns[1][search][value]}
	         </isNotEmpty>
			 <isNotEmpty property="columns[2][search][value]">
	         	AND B.SEAL_NO LIKE '%${columns[2][search][value]}%'
	         </isNotEmpty>
			 <isNotEmpty property="columns[3][search][value]">
	         	AND T.SHIP_NAME like '%${columns[3][search][value]}%'
	         </isNotEmpty>
			 <isNotEmpty property="columns[4][search][value]">
	         	AND T.SHIP_VOYAGE LIKE '%${columns[4][search][value]}%'
	         </isNotEmpty>
			 <isNotEmpty property="columns[5][search][value]">
	         	AND T.SHIP_DATE = #{columns[5][search][value]}
	         </isNotEmpty>
			 <isNotEmpty property="columns[6][search][value]">
	         	AND T.IS_FINISH = #{columns[6][search][value]}
	         </isNotEmpty>
			 <isNotEmpty property="columns[7][search][value]">
	         	AND T.CARGO_OWNER_ID = #{columns[7][search][value]}
	         </isNotEmpty>
			 <isNotEmpty property="columns[8][search][value]">
	         	AND T.KEYWORD LIKE '%${columns[8][search][value]}%'
	         </isNotEmpty>
	        <isEmpty property="query_count">
	        		ORDER BY T.CREATE_TIME DESC
	        	
	        	<!-- <isNotEmpty property="order[0][column]">	        	
					<isEqual property="order[0][column]" compareValue="1"><isNotEmpty property="order[0][dir]">ORDER BY INO ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="2"><isNotEmpty property="order[0][dir]">ORDER BY ISFINISH ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="3"><isNotEmpty property="order[0][dir]">ORDER BY ORDER_NO ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="4"><isNotEmpty property="order[0][dir]">ORDER BY SHIP_NAME ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="5"><isNotEmpty property="order[0][dir]">ORDER BY SHIP_VOYAGE ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="6"><isNotEmpty property="order[0][dir]">ORDER BY SHIP_DATE ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="7"><isNotEmpty property="order[0][dir]">ORDER BY CARGO_OWNNER ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="8"><isNotEmpty property="order[0][dir]">ORDER BY BOXTAKE ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="9"><isNotEmpty property="order[0][dir]">ORDER BY BOXOWNNER1 ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="10"><isNotEmpty property="order[0][dir]">ORDER BY ADDR ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="11"><isNotEmpty property="order[0][dir]">ORDER BY LOADPORT ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="12"><isNotEmpty property="order[0][dir]">ORDER BY BOX_NUMS ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="13"><isNotEmpty property="order[0][dir]">ORDER BY ALL_COST ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="14"><isNotEmpty property="order[0][dir]">ORDER BY FEE_REMARK ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="15"><isNotEmpty property="order[0][dir]">ORDER BY BOXDRAGAREA ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="16"><isNotEmpty property="order[0][dir]">ORDER BY BOXRETURN ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="17"><isNotEmpty property="order[0][dir]">ORDER BY PAYER ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="18"><isNotEmpty property="order[0][dir]">ORDER BY LOAD_CONTACT ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="19"><isNotEmpty property="order[0][dir]">ORDER BY ORDER_REMARK ${order[0][dir]}</isNotEmpty></isEqual>
					<isEqual property="order[0][column]" compareValue="20"><isNotEmpty property="order[0][dir]">ORDER BY TOPORT ${order[0][dir]}</isNotEmpty></isEqual>
	        	</isNotEmpty> -->
	        	LIMIT ${page_start},${page_end}
	        	) A,(SELECT @I:= ${page_start} ) IT
	        </isEmpty>
	    </sql>
	</mapper>
	
	<!-- 查询运单详细信息 -->
	<mapper id="queryOrderInfo">
		<sql key="queryOrderInfo" resultType="map" operator="select">
			SELECT T.ORDER_ID,
		       T.TAG,
		       T.ORDER_NO,
		       DATE_FORMAT(T.ORDER_DATE, '%Y-%m-%d %H:%i') ORDER_DATE,
		       T.SCHEDULE_CENTER,
		       (SELECT T.CENTER_NAME FROM tab_schedule_center T WHERE T.CENTER_CODE=T.SCHEDULE_CENTER LIMIT 1) SCHEDULECENTER,
		       T.LOAD_WAY,
		       (SELECT D.TEXT FROM dict_common D WHERE D.TYPE = 'LOADWAY' AND D.CODE = T.LOAD_WAY) LOADWAY,
		       T.IN_OUT,
		       (SELECT D.TEXT FROM dict_common D WHERE D.TYPE = 'INOTYPE' AND D.CODE = T.IN_OUT) INO,
		       T.SHIP_NAME,
		       T.SHIP_VOYAGE,
		       DATE_FORMAT(T.SHIP_DATE, '%Y-%m-%d') SHIP_DATE,
		       T.CARGO_OWNER_ID,
		       (SELECT C.COMPANY FROM tab_cargo_ownner C WHERE C.OWNNER_ID=T.CARGO_OWNER_ID LIMIT 1) CARGOOWNER,
		       T.CARGO_OWNNER,
		       T.OWNNER_NAME,
		       T.OWNNER_TEL,
		       T.CARGO_PROXY_ID,
		       (SELECT C.COMPANY FROM tab_cargo_ownner C WHERE C.OWNNER_ID=T.CARGO_PROXY_ID LIMIT 1) CARGOPROXY,
		       T.CARGO_PROXY,
		       T.PROXY_NAME,
		       T.PROXY_TEL,
		       T.BOX_OWNNER_1,
		       (SELECT TRIM(O.SHORTCUT) FROM tab_box_ownner O WHERE O.OWNNER_ID=T.BOX_OWNNER_1 LIMIT 1) BOXOWNNER1,
		       T.BOX_OWNNER_2,
		       (SELECT TRIM(O.SHORTCUT) FROM tab_box_ownner O WHERE O.OWNNER_ID=T.BOX_OWNNER_2 LIMIT 1) BOXOWNNER2,
		       T.TO_PORT,
		       (SELECT CONCAT(P.PORT_CODE,' ',P.PORT_CN) PORT_CN FROM tab_port P WHERE P.PORT_CODE=T.TO_PORT LIMIT 1) TOPORT,
		       T.LOAD_PORT,
		       (SELECT CONCAT(P.PORT_CODE,' ',P.PORT_CN) PORT_CN FROM tab_port P WHERE P.PORT_CODE=T.LOAD_PORT LIMIT 1) LOADPORT,
		       T.BOX_TAKE,
		       (SELECT A.NAME FROM dict_area A WHERE A.CODE=T.BOX_TAKE LIMIT 1) BOXTAKE,
		       T.BOX_DRAG,
		       (SELECT A.NAME FROM dict_area A WHERE A.CODE=T.BOX_DRAG LIMIT 1) BOXDRAG,
		       T.BOX_DRAG_AREA,
			   (SELECT CONCAT(C.PROVINCE,C.SIMPLE_CITY,C.TEXT) FROM base_area_tab C WHERE C.CODE=T.BOX_DRAG_AREA LIMIT 1) BOXDRAGAREA,
		       T.BOX_RETURN,
		       (SELECT A.NAME FROM dict_area A WHERE A.CODE=T.BOX_RETURN LIMIT 1) BOXRETURN,
		       T.SHIPMENT_NO,
		       T.LOAD_CONTACT,
		       T.ADDR,
		       T.PAYER,
		       T.CARGO_REMARK,
		       T.CARGO_NAME,
		       T.CARGO_NUM,
		       T.CARGO_WEIGHT,
		       T.CARGO_SIZE,
		       T.CARGO_TEMPRETURE,
		       T.CUSTOMS,
		       T.ORDER_PRINT,
		       T.SEAL_FROM,
		       T.SALESMAN,
		       T.TARIFF,
		       T.FEE_LIMITED,
		       T.WAIGUAN,
			   T.WEITUOBIANJIAN,
			   T.BIANJIANEDI,
			   T.FANGXIANG,
			   T.XUNZHENG,
			   T.SHENBEIDAN,
			   T.WAIXIE,
		       T.ORDER_REMARK,
		       T.FEE_REMARK,
		       T.KEYWORD,
		       T.CREATE_USER_ID,
		       T.CREATE_USER,
		       DATE_FORMAT(T.CREATE_TIME, '%Y-%m-%d %T') CREATE_TIME,
		       T.OP_USER_ID,
		       T.OP_USER,
		       DATE_FORMAT(T.OP_TIME, '%Y-%m-%d %T') OP_TIME,
		       T.IS_FINISH,
		       (SELECT D.TEXT FROM dict_common D WHERE D.TYPE = 'ORDERTYPE' AND D.CODE = T.IS_FINISH) ISFINISH,
		       T.IS_DEL,
		       T.BOX_NUMS,
			   T.ALL_COST,
			   T.IS_RESERVE,
			   T.IS_INSTEAD
	          FROM tab_order T WHERE T.ORDER_ID = #{ORDER_ID}
		</sql>
	    <sql key="feeList" resultType="list" operator="select">
	    	SELECT F.TYPE FEE_TYPE,F.AMOUNT FEE_AMOUNT FROM tab_order_fee F 
	    		WHERE F.ORDER_ID=#{ORDER_ID} AND F.IS_DEL='N'
		</sql>
	</mapper>
	<!-- 获取费用信息列表 -->
	<mapper id="getOrderFeeList">
	    <sql key="getOrderFeeList" resultType="list" operator="select">
			SELECT DISTINCT F.FEE_ID,
			                F.TYPE FEE_TYPE,
			                (SELECT D.FEE_TYPE
			                   FROM dict_fee D
			                  WHERE D.FEE_CODE = F.TYPE LIMIT 1) FEETYPE,
			                F.AMOUNT FEE_AMOUNT,
			                F.REMARK FEE_REMARK
			  FROM tab_order_fee F
			 WHERE F.IS_DEL = 'N'
			   AND F.ORDER_ID = #{ORDER_ID}
			 ORDER BY F.SORT, F.CREATE_TIME
		</sql>
	</mapper>
	
	<!-- 获取集装箱信息列表  BOX_LAST_STATE 箱子的最近状态 提箱/送箱/回箱/进场/空跑/退载 -->
	<mapper id="getOrderBoxList">
	    <sql key="getOrderBoxList" resultType="list" operator="select">
	    	SELECT B.BOX_ID,
			       B.SIZE,
			       B.SPEC,
			       B.NO,
			       B.SEAL_NO,
			       B.ADDR_TX,
			       (SELECT TRIM(A.NAME)
			          FROM dict_area A
			         where A.CODE = B.ADDR_TX limit 1) ADDRTX,
			       B.LOAD_CONTACT,
			       B.ADDR,
			       B.BOX_REMARK,
			       BOX_LAST_STATE,
			       SCHEDULE_ID
			  FROM tab_order_box B
			 WHERE B.IS_DEL = 'N'
			   AND B.ORDER_ID = #{ORDER_ID}
			 ORDER BY B.SORT, B.CREATE_TIME
		</sql>
	</mapper>
	
	<!-- 订单处理 选择箱子  暂时没用 -->
	<mapper id="queryBoxTypeList">
	    <sql key="queryBoxTypeList" resultType="list" operator="select">
	    	SELECT D.TEXT SIZE FROM dict_common D WHERE D.TYPE='BOX_SIZE' AND D.IS_DEL='N'
		</sql>
	</mapper>
		
	<!-- 关联信息下拉框数据查询 -->	
	
	<!-- 根据船名获取航线 -->
	<mapper id="getOrderShipVoyage">
		<sql key="getOrderShipVoyage" resultType="map" operator="select">
			SELECT MAX(S.LINE) LINE FROM tab_ship S WHERE S.NAME_CN = #{SHIP_NAME}
		</sql>
	</mapper>
	
	<!-- 选中货主时回填货主其他信息 -->
	<mapper id="getOrderOwnerInfo">
		<sql key="getOrderOwnerInfo" resultType="map" operator="select">
			SELECT C.COMPANY,C.LINKMAN,C.LINKTEL FROM tab_cargo_ownner C WHERE C.OWNNER_ID=#{OWNNER_ID}
		</sql>
	</mapper>
	
	<!-- 新增费用类型 -->
	<mapper id="addFee">
	    <sql key="addFee" operator="execute" >
	    	INSERT INTO dict_fee (FEE_TYPE,FEE_CODE) VALUES (#{FEE_TYPE},#{FEE_CODE})
	    </sql>
	</mapper>
	
	<!-- 预约标记 取消预约标记  -->
	<mapper id="toOrderReserve">
	    <sql key="toOrderReserve" operator="execute" >
	    	UPDATE tab_order T
			   SET T.IS_RESERVE = #{IS_RESERVE}, T.RESERVE_TIME = NOW(),T.RESERVE_USERID='$_CRU_USER_ID_$'
			 WHERE T.ORDER_ID = #{ORDER_ID} LIMIT 1
	    </sql>
	</mapper>
</mappers>