<?xml version="1.0" encoding="UTF-8"?>

<mappers xmlns="http://www.weimingfj.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://itest.56913.com:20080/xsd/mappers.xsd">
	
	<mapper id="queryTruckStatusList">
		<sql key="queryTruckStatusList" resultType="paging" operator="select">
			select 
			<isEmpty property="query_count">
	           (@i:=@i+1) SEQ,
	           a.*     
	        </isEmpty>
	        <isNotEmpty property="query_count"> count(1) </isNotEmpty> 
	        from ( select 
	        tts.DRIVER,
	        tts.DRIVER_TEL,
	        tts.ORDER_NO,
	        tts.BOX_NO,
	        tts.ST_ORDER_NO,
	        tts.ST_BOX_NO,
	        tts.SCHEDULE_STATUS,
	        tts.TRUCK_PLATE,
	        tts.TRUCK_FRAME,
	        date_format(tts.SEND_TIME,'%Y-%m-%d %H:%i')SEND_TIME,
	        date_format(tts.ARRIVE_TIME,'%Y-%m-%d %H:%i')ARRIVE_TIME,
	        tts.LOC_ADDRESS,
	        date_format(tts.LAST_LOC_TIME,'%Y-%m-%d %T')LAST_LOC_TIME,
	        tts.STATUS_ID
	        	 
	        from tab_truck_status tts
	         where 1=1 
	        <isNotEmpty property="columns[0][search][value]">
	           and tts.driver like '%${columns[0][search][value]}%'     
	        </isNotEmpty>
	        <isNotEmpty property="columns[1][search][value]">
	           and tts.ORDER_NO like '%${columns[1][search][value]}%'    
	        </isNotEmpty>
	        <isNotEmpty property="columns[2][search][value]">
	           and tts.TRUCK_FRAME = #{columns[2][search][value]}       
	        </isNotEmpty>
	        <isNotEmpty property="columns[3][search][value]">
	           and date_format(tts.LAST_LOC_TIME,'%Y-%m-%d') = date_format(#{columns[3][search][value]},'%Y-%m-%d')       
	        </isNotEmpty>
	        <isNotEmpty property="columns[4][search][value]">
	           and tts.SCHEDULE_STATUS = #{columns[4][search][value]}   
	        </isNotEmpty>
	        <isNotEmpty property="columns[5][search][value]">
	           and tts.DRIVER_TEL like '%${columns[5][search][value]}%'      
	        </isNotEmpty>
	        <isNotEmpty property="columns[6][search][value]">
	           and tts.BOX_NO like '%${columns[6][search][value]}%'        
	        </isNotEmpty>
	        <isNotEmpty property="columns[7][search][value]">
	           and tts.TRUCK_PLATE like '%${columns[7][search][value]}%'       
	        </isNotEmpty>
	        <isNotEmpty property="columns[8][search][value]">
	           and tts.LOC_ADDRESS like '%${columns[8][search][value]}%'       
	        </isNotEmpty>
	        <isNotEmpty property="columns[9][search][value]">
	           and (tts.driver like '%${columns[9][search][value]}%' or tts.DRIVER_TEL like '%${columns[9][search][value]}%' 
	           or tts.ORDER_NO like '%${columns[9][search][value]}%' or tts.TRUCK_PLATE like '%${columns[9][search][value]}%' 
	           or tts.SCHEDULE_STATUS like '%${columns[9][search][value]}%' or tts.TRUCK_FRAME like '%${columns[9][search][value]}%'
	           or tts.LAST_LOC_TIME like '%${columns[9][search][value]}%' )       
	        </isNotEmpty>
	        <isEmpty property="query_count">
	        order by date_format(tts.LAST_LOC_TIME,'%Y-%m-%d %T') desc 
	        limit ${page_start},${numPerPage})a,(select   @i:=${page_start}) as it 
	        </isEmpty>
	        <isNotEmpty property="query_count">
	        ) a
	        </isNotEmpty>
		</sql>
	</mapper>
	<!-- 车辆监控地图列表数据查询 -->
	<mapper id="queryTruckStatusDriverList">
		<sql key="queryTruckStatusDriverList" resultType="paging" operator="select">
			select 
			<isEmpty property="query_count">
	           (@i:=@i+1) SEQ,tts.*      
	        </isEmpty>
	        <isNotEmpty property="query_count"> count(1) </isNotEmpty> 
	        from tab_truck_status tts,(select   @i:=0) as it 
	         where 1=1 
	        <isNotEmpty property="columns[0][search][value]">
	           and tts.driver like '%${columns[0][search][value]}%'     
	        </isNotEmpty>
	        <isNotEmpty property="columns[1][search][value]">
	           and tts.ORDER_NO like '%${columns[1][search][value]}%'    
	        </isNotEmpty>
	        <isNotEmpty property="columns[2][search][value]">
	           and tts.TRUCK_FRAME = #{columns[2][search][value]}       
	        </isNotEmpty>
	        <isNotEmpty property="columns[3][search][value]">
	           and date_format(tts.LAST_LOC_TIME,'%Y-%m-%d %T') >= date_format(#{columns[3][search][value]},'%Y-%m-%d 00:00:00')
	           and date_format(tts.LAST_LOC_TIME,'%Y-%m-%d %T') &lt;= date_format(#{columns[3][search][value]},'%Y-%m-%d 23:59:59')       
	        </isNotEmpty>
	        <isNotEmpty property="columns[4][search][value]">
	           and tts.SCHEDULE_STATUS = #{columns[4][search][value]}   
	        </isNotEmpty>
	        <isNotEmpty property="columns[5][search][value]">
	           and tts.DRIVER_TEL like '%${columns[5][search][value]}%'      
	        </isNotEmpty>
	        <isNotEmpty property="columns[6][search][value]">
	           and tts.BOX_NO like '%${columns[6][search][value]}%'        
	        </isNotEmpty>
	        <isNotEmpty property="columns[7][search][value]">
	           and tts.TRUCK_PLATE like '%${columns[7][search][value]}%'       
	        </isNotEmpty>
	        <isNotEmpty property="columns[8][search][value]">
	           and tts.LOC_ADDRESS like '%${columns[8][search][value]}%'       
	        </isNotEmpty>
	        <isNotEmpty property="columns[9][search][value]">
	           and (tts.driver like '%${columns[9][search][value]}%' or tts.DRIVER_TEL like '%${columns[9][search][value]}%' 
	           or tts.ORDER_NO like '%${columns[9][search][value]}%' or tts.TRUCK_PLATE like '%${columns[9][search][value]}%' 
	           or tts.SCHEDULE_STATUS like '%${columns[9][search][value]}%' or tts.TRUCK_FRAME like '%${columns[9][search][value]}%'
	           or tts.LAST_LOC_TIME like '%${columns[9][search][value]}%' )       
	        </isNotEmpty>
	        <isEmpty property="query_count">
	        order by date_format(tts.LAST_LOC_TIME,'%Y-%m-%d %T') desc 
	        </isEmpty>
		</sql>
	</mapper>
	<!-- 获取车辆监控信息 -->
	<mapper id="queryTruckStatusMsg">
		<sql key="queryTruckStatusMsg" resultType="list" operator="select">
			select * from tab_truck_status where 1=1  
			<isNotEmpty property="STATUS_ID">
			and status_id=#{STATUS_ID}
			</isNotEmpty>
		</sql>
	</mapper>
	<!-- 获取车架号 -->
	<mapper id="queryTruckFrame">
		<sql key="queryTruckFrame" operator="select" resultType="list">
			select truck_plate id,truck_plate text from tab_frame_truck where type='F'
		</sql>
	</mapper>
	<!-- 获取车辆定位点 -->
	<mapper id="queryTruckLine">
		<sql key="queryTruckLine" operator="select" resultType="list">
			SELECT DISTINCT
				FORMAT(ttgd.lon,3) AS LNG,
				FORMAT(ttgd.lat,3) AS LAT
			FROM
				tab_truck_gps_data ttgd
			LEFT JOIN tab_truck_status tts ON ttgd .vehicleno = tts.truck_plate
			WHERE 1=1
			<!-- ttgd.uptime>='2016-03-07 10:00:00' 
			AND ttgd.uptime&lt;='2016-03-07 10:10:59'  -->
			<isNotEmpty property="beginDate">
				AND ttgd.uptime>=date_format(#{beginDate},'%Y-%m-%d %T') 
			</isNotEmpty>
			<isNotEmpty property="endDate">
				AND ttgd.uptime&lt;=date_format(#{endDate},'%Y-%m-%d %T') 
			</isNotEmpty>
			<isEmpty property="STATUS_ID">
			</isEmpty>
			<isNotEmpty property="STATUS_ID">
			AND tts.status_id=#{STATUS_ID} 
			</isNotEmpty> 
			ORDER BY ttgd.uptime
		</sql>
	</mapper>
	
	<!-- 车辆监控详细信息 -->
	<mapper id="queryTruckStatusDetail">
	    <sql key="queryTruckStatusDetail" resultType="map" operator="select">
	        SELECT
				sc.SCHEDULE_ID,
				dc.text COMMAND,
				sc.EMPTY_STATUS,
				sc.`FROM`,
				sc.`TO`,
				tsc.center_name AS SCHEDULE_CENTER,
				sc.WAIXIE,
				sc.OUT_HELP,
				sc.SHUANGTUO,
				sc.SHUAIGUI,
				sc.beigui,
				ts.DRIVER,
				ts.SEND_TIME,
				ts.TRUCK_PLATE,
				ts.TRUCK_FRAME,
				ts.ORDER_NO,
				tco.company CARGO_OWNNER,
				o.SHIPMENT_NO,
				o.LOAD_CONTACT,
				o.ADDR,
				o.CARGO_NAME,
				o.CARGO_REMARK,
				o.SHIP_NAME,
				o.SHIP_VOYAGE,
				ts.BOX_NO,
				ts.box_id,
				tbo.LINKNAME AS OWNNER,
				ob.SIZE,
				ob.SPEC,
				ob.SEAL_NO,
				ob.BOX_REMARK,
				o.order_remark SCHEDULE_REMARK,
			
				<!-- 双拖箱子信息 -->
				stsc.shuangtuo_schedule_id ST_SCHEDULE_ID,
				stdc.text ST_COMMAND,
				stsc.EMPTY_STATUS ST_EMPTY_STATUS,
				stsc.`FROM` ST_FROM,
				stsc.`TO` ST_TO,
				sttsc.center_name AS ST_SCHEDULE_CENTER,
				ts.st_ORDER_NO,
				sttco.company ST_CARGO_OWNNER,
				sto.SHIPMENT_NO ST_SHIPMENT_NO,
				sto.LOAD_CONTACT ST_LOAD_CONTACT,
				sto.ADDR ST_ADDR,
				sto.CARGO_NAME ST_CARGO_NAME,
				sto.CARGO_REMARK ST_CARGO_REMARK,
				sto.SHIP_NAME ST_SHIP_NAME,
				sto.SHIP_VOYAGE ST_SHIP_VOYAGE,
				ts.st_BOX_NO,
				ts.st_box_id,
				sttbo.LINKNAME AS st_OWNNER,
				stob.SIZE ST_SIZE,
				stob.SPEC ST_SPEC,
				stob.SEAL_NO ST_SEAL_NO,
				stob.BOX_REMARK ST_BOX_REMARK,
				sto.order_remark ST_SCHEDULE_REMARK
			FROM
				tab_truck_status ts
			LEFT JOIN tab_order_box_schedule sc ON ts.schedule_id = sc.schedule_id
			LEFT JOIN tab_order_box ob ON ob.box_id = ts.box_id
			LEFT JOIN tab_order o ON o.order_id = ts.order_id
			LEFT JOIN tab_box_ownner tbo ON o.box_ownner_1 = tbo.ownner_id
			LEFT JOIN tab_cargo_ownner tco ON o.cargo_owner_id = tco.ownner_id
			LEFT JOIN tab_schedule_center tsc ON sc.schedule_center = tsc.center_code
			<!-- 双拖箱子左连接 -->
			LEFT JOIN tab_order_box_schedule stsc ON sc.shuangtuo_schedule_id=stsc.schedule_id
			LEFT JOIN tab_order_box stob ON stob.box_id = ts.box_id
			LEFT JOIN tab_order sto ON sto.order_id = ts.order_id
			LEFT JOIN tab_box_ownner sttbo ON sto.box_ownner_1 = sttbo.ownner_id
			LEFT JOIN tab_cargo_ownner sttco ON sto.cargo_owner_id = sttco.ownner_id
			LEFT JOIN tab_schedule_center sttsc ON stsc.schedule_center=sttsc.center_code
			LEFT JOIN dict_common dc ON (
				sc.command = dc.`code`
				AND dc.type = 'SCHEDULENAME'
			)
			LEFT JOIN dict_common stdc ON (
				stsc.command = stdc.`code`
				AND stdc.type = 'SCHEDULENAME'
			)
			WHERE
				ts.status_id =#{STATUS_ID}
	    </sql>
	</mapper>
	
	<!-- 获取上一条箱子调度的终点作为新增调度的起点 -->
	<mapper id="getScheduleFrom">
		<sql key="getScheduleFrom" resultType="map" operator="select">
			SELECT * FROM tab_order_box_schedule WHERE box_id = #{box_id} ORDER BY create_time DESC LIMIT 0,1;
		</sql>
	</mapper>
</mappers>