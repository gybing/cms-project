<?xml version="1.0" encoding="UTF-8"?>
<mappers xmlns="http://www.weimingfj.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://itest.56913.com:20080/xsd/mappers.xsd">
	
	<!-- 调度管理列表 -->
	<mapper id="scheduleList">
	    <sql key="scheduleList" resultType="paging" operator="select">
	   	 SELECT
			<isNotEmpty property="query_count">
				COUNT(1)
			</isNotEmpty>
			<isEmpty property="query_count">
	        b.*,(@i:=@i+1) as  NUM
			from 
	        (
		        select 
		        o.order_id,box.box_id,DATE_FORMAT(s.send_time,'%Y-%m-%d %H:%i') send_time_format, o.in_out,box.create_time,
				box.xunzheng,box.shangjian,box.jigui,box.pangui,(CASE s.schedule_status WHEN '1' THEN '执行中' WHEN '2' THEN '已执行' ELSE '未执行' END) schedule_status,
	            s.shuaigui,s.beigui,
	            s.shuangtuo,
				s.command,box.schedule_remark,s.to toname,
				DATE_FORMAT(box.book_send_date,'%Y-%m-%d %H:%i') book_send_date,
			 	box.is_ys sf_sx,box.is_yt sf_tx,box.is_yh sf_hx,box.is_jc sf_jc,
			 	box.is_reserve,box.JSON_HIS,
				s.truck_plate,s.truck_frame, DATE_FORMAT(o.ship_date,'%Y-%m-%d') ship_date,o.ship_name,
				o.ship_voyage,o.order_no,box.no,box.seal_no,box.size,box.spec,tbo.shortcut box_ownner_1,o.box_ownner_2,
			 	(select da.name from dict_area da where da.code=o.box_take LIMIT 0,1) box_take,
				(select da.name from dict_area da where da.code=o.box_return LIMIT 0,1) box_return,
				(select ifnull(tp.port_en,tp.port_cn) name from tab_port tp where tp.port_code=o.load_port LIMIT 0,1) load_port,
				(select ifnull(tp.port_en,tp.port_cn) name from tab_port tp where tp.port_code=o.to_port LIMIT 0,1) to_port,
				(select bat.full_text name from base_area_tab bat where bat.code=o.box_drag_area LIMIT 0,1) box_drag_area,
				(select da.name from dict_area da where da.code=o.box_drag LIMIT 0,1) box_drag,
				o.cargo_ownner,o.ownner_name,o.ownner_tel,o.addr,o.shipment_no,o.load_way,o.load_contact
				</isEmpty>
				from tab_order_box box left join tab_order o on o.order_id = box.order_id
				left join tab_order_box_schedule s on box.schedule_id=s.schedule_id and s.is_del='N'
				left join tab_box_ownner tbo on tbo.ownner_id = o.box_ownner_1
				left join tab_cargo_ownner tco on tco.ownner_id = o.cargo_owner_id
				where box.is_del='N' and o.is_del='N'
			<isNotEmpty property="columns[1][search][value]">
	        	<isEqual property="columns[0][search][value]" compareValue="TDH">
	        		and o.order_no like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="XH">
	        		and box.no like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="QFH">
	        		and box.seal_no like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="CC">
	        		and box.size like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="XG">
	        		and box.spec like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="CM">
	        		and o.ship_name like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="CQ">
	        		and o.ship_date like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="HC">
	        		and o.ship_voyage like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="TXDD">
	        		and ( select da.name from dict_area da where da.code=o.box_take LIMIT 0,1 ) like '%${columns[1][search][value]}%' 
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="FXDD">
	        		and (select da.name from dict_area da where da.code=o.box_return LIMIT 0,1 ) like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="CP">
	        		and s.truck_plate like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="CJ">
	        		and s.truck_frame like '%${columns[1][search][value]}%'
	        	</isEqual>
	        	<isEqual property="columns[0][search][value]" compareValue="XZ">
	        		and tbo.shortcut like '%${columns[1][search][value]}%'
	        	</isEqual>
	        </isNotEmpty>
	        
	        <isNotEmpty property="columns[3][search][value]">
	        	<isEqual property="columns[3][search][value]" compareValue="YT">
	        		and box.is_yt = 'Y'
	        		<!-- and (select ss.schedule_status from tab_order_box_schedule ss,dict_area d1 where ss.box_id=box.box_id and ss.to = d1.code and ss.command='1' and ss.schedule_status = '2'  order by ss.create_time desc limit 1 ) ='1' -->
	        	</isEqual>
				<isEqual property="columns[3][search][value]" compareValue="YS">
					and box.is_ys = 'Y'
	        		<!-- and (select ss.schedule_status from tab_order_box_schedule ss,dict_area d1 where ss.box_id=box.box_id and ss.to = d1.code and ss.command='2' and ss.schedule_status = '2'  order by ss.create_time desc limit 1 ) ='1' -->
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="YH">
	        		and box.is_yh = 'Y'
	        		<!-- and (select ss.schedule_status from tab_order_box_schedule ss,dict_area d1 where ss.box_id=box.box_id and ss.to = d1.code and ss.command='3' and ss.schedule_status = '2'  order by ss.create_time desc limit 1 ) ='1' -->
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="TZ">
	        		and s.command='8' 
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="YJC">
	        		and ( s.command='4' and s.schedule_status = '2' )
	        		<!-- and (select ss.schedule_status from tab_order_box_schedule ss,dict_area d1 where ss.box_id=box.box_id and ss.to = d1.code and ss.command='4' and ss.schedule_status = '2'  order by ss.create_time desc limit 1 ) ='2' -->
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="WZX">
	        		and (s.schedule_status = '0' or box.schedule_id is null or box.schedule_id = '')
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="ZXZ">
	        		and (s.schedule_status = '1')
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="YZX">
	        		and (s.schedule_status = '2')
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="WYZ">
	        		and (s.schedule_status = '0' or box.schedule_id is null or box.schedule_id = '')
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="DR">
	        		and date_format(box.create_time,'%Y-%m-%d') = date(now())
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="CR">
	        		and date_format(box.create_time,'%Y-%m-%d') = date_sub(curdate(),interval 1 day)
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="BZ">
	        		and YEARWEEK(date_format(box.create_time,'%Y-%m-%d')) = YEARWEEK(now())
	        	</isEqual>
	        	<isEqual property="columns[3][search][value]" compareValue="YC">
	        		and s.yichang = '1'
	        	</isEqual> 
			</isNotEmpty>
			
			<isNotEmpty property="columns[2][search][value]">
				<isEqual property="columns[2][search][value]" compareValue="TODAY">
					and TO_DAYS(s.send_time )=TO_DAYS(NOW()) 
				</isEqual>
				<isEqual property="columns[2][search][value]" compareValue="YESTODAY">
					and TO_DAYS( NOW( ) ) - TO_DAYS(s.send_time) = -1 
				</isEqual>
				<!-- 本周 DAYOFWEEK(now())算出今天是本周第几天，然后就算后几天的数据 -->
				<!-- <isEqual property="columns[2][search][value]" compareValue="WEEK">
					and DATE_SUB(CURDATE(), INTERVAL -DAYOFWEEK(now()) DAY) >= date(s.send_time) 
					and date(s.send_time) >=CURDATE() 
				</isEqual> -->
				<!-- 前7天 -->
				<isEqual property="columns[2][search][value]" compareValue="WEEK">
					and DATE_SUB(CURDATE(), INTERVAL -7 DAY) >= date(s.send_time) and date(s.send_time) >=CURDATE() 
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="columns[4][search][value]">
				and box.keyword like '%${columns[4][search][value]}%'
			</isNotEmpty>
			<isEmpty property="query_count">
				ORDER BY box.create_time desc,s.send_time desc
				LIMIT ${page_start},${page_end}
			) b,(select   @i:=${page_start})   as   it 
			</isEmpty>
	    </sql>
	</mapper>
	
	<mapper id="scheduleSum">
		 <sql key="scheduleSum" resultType="map" operator="select">
	        select sum(case when command='1' then 1 else 0 end) txnum,
			 sum(case when command='2' then 1 else 0 end) sxnum,
			 sum(case when command='3' then 1 else 0 end) hxnum,
			 sum(case when command='4' then 1 else 0 end) jcnum,
			 sum(case when command='5' then 1 else 0 end) zcnum,
			 sum(case when command='6' then 1 else 0 end) kpnum,
			 sum(case when command='7' then 1 else 0 end) tknum,
			 sum(case when command='8' then 1 else 0 end) tznum
			from tab_order_box_schedule where 1=1 and is_del = 'N'
	    </sql>
		
	</mapper>
	
	
	
	<!-- 导出调度列表 -->
	<mapper id="ExportScheduleList">
		<sql key="ExportScheduleList" resultType="list" dynamic="true"
			operator="select">
			select (@i:=@i+1) as  NUM,a.*, 
		  	(case when  a.is_ys = 'Y' then '√'   else '' end ) sf_sx,
			(case when  a.is_yt = 'Y' then '√'   else '' end ) sf_tx,
			(case when  a.is_yh = 'Y' then '√'   else '' end ) sf_hx,
			(case when  a.is_jc = 'Y' then '√'   else '' end  ) sf_jc
			 from
			( select o.order_id,box.box_id,DATE_FORMAT(s.send_time,'%Y-%m-%d %H:%i') send_time,(select iout.text from dict_common iout where o.in_out=iout.code and iout.type='INOTYPE') in_out,box.create_time,
            (CASE s.beigui WHEN 1 THEN '√' ELSE '' END) beigui,
			box.xunzheng,box.shangjian,box.jigui,box.pangui,(CASE s.schedule_status WHEN '1' THEN '执行中' WHEN '2' THEN '已执行' ELSE '未执行' END) schedule_status,
            (CASE s.shuaigui WHEN 1 THEN '√' ELSE '' END) shuaigui,
            (CASE s.shuangtuo WHEN 1 THEN '√' ELSE '' END) shuangtuo,
			(select dc.text from dict_common dc where dc.code=s.command and dc.type='SCHEDULENAME') command,box.schedule_remark,(select da.name from dict_area da where da.code=s.to) toname,
			DATE_FORMAT(box.book_send_date,'%Y年%m月%d日 %H时%i分') book_send_date,
			(select s1.driver from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='2' order by s1.create_time desc limit 1 ) sx_driver,
			(select s1.send_time from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='2'order by s1.create_time desc limit 1 ) sx_time,
			(select s1.driver from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='1' order by s1.create_time desc limit 1 ) tx_driver,
			(select s1.send_time from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='1'order by s1.create_time desc limit 1 ) tx_time,
			(select s1.driver from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='3' order by s1.create_time desc limit 1 ) hx_driver,
			(select s1.send_time from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='3'order by s1.create_time desc limit 1 ) hx_time,
			(select s1.driver from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='4' order by s1.create_time desc limit 1 ) jc_driver,
			(select s1.send_time from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='4'order by s1.create_time desc limit 1 ) jc_time,
			(select s1.schedule_no from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='1' order by s1.create_time desc limit 1 ) tx_schedule_no,
			(select s1.schedule_no from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='2' order by s1.create_time desc limit 1 ) sx_schedule_no,
			(select s1.schedule_no from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='3' order by s1.create_time desc limit 1 ) hx_schedule_no,
			(select s1.schedule_no from tab_order_box_schedule s1 where s1.box_id=box.box_id and s1.command='4' order by s1.create_time desc limit 1 ) jc_schedule_no,
			box.is_ys,box.is_yt,box.is_yh,box.is_jc,
			s.truck_plate,s.truck_frame,o.ship_date,o.ship_name,o.ship_voyage,o.order_no,box.no,box.seal_no,box.size,box.spec,tbo.shortcut box_ownner_1,o.box_ownner_2,
		 	(select da.name from dict_area da where da.code=o.box_take LIMIT 0,1) box_take,
			(select da.name from dict_area da where da.code=o.box_return LIMIT 0,1) box_return,
			(select IF(tp.port_cn = '',tp.port_en,tp.port_cn) name from tab_port tp where tp.port_code=o.load_port LIMIT 0,1) load_port,
			(select IF(tp.port_cn = '',tp.port_en,tp.port_cn) name from tab_port tp where tp.port_code=o.to_port LIMIT 0,1) to_port,
			(select da.name from dict_area da where da.code=o.box_drag_area LIMIT 0,1) box_drag_area,
			(select da.name from dict_area da where da.code=o.box_drag LIMIT 0,1) box_drag,
			tco.company cargo_ownner,o.ownner_name,o.ownner_tel,o.addr,o.shipment_no,
			(select dc.text from dict_common dc where dc.type = 'LOADWAY' and dc.code=o.load_way LIMIT 0,1)  load_way 
			
			from tab_order o left join tab_order_box box on o.order_id = box.order_id
			
			left join tab_order_box_schedule s on box.schedule_id=s.schedule_id and s.is_del='N'
			left join tab_box_ownner tbo on tbo.ownner_id = o.box_ownner_1
			left join tab_cargo_ownner tco on tco.ownner_id = o.cargo_owner_id
			where box.is_del='N' and o.is_del='N'

			
			<isNotEmpty property="SSTJ_VALUE">
	        	<isEqual property="SSTJ" compareValue="TDH">
	        		and o.order_no like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="XH">
	        		and box.no like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="QFH">
	        		and box.seal_no like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="CC">
	        		and box.size like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="XG">
	        		and box.spec like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="CM">
	        		and o.ship_name like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="CQ">
	        		and o.ship_date like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="HC">
	        		and o.ship_voyage like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="TXDD">
	        		and ( select da.name from dict_area da where da.code=o.box_take LIMIT 0,1 ) like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="FXDD">
	        		and (select da.name from dict_area da where da.code=o.box_return LIMIT 0,1 ) like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="CP">
	        		and s.truck_plate like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="CJ">
	        		and s.truck_frame like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        	<isEqual property="SSTJ" compareValue="XZ">
	        		and tbo.shortcut like '%${SSTJ_VALUE}%'
	        	</isEqual>
	        </isNotEmpty>
	        
	        <isNotEmpty property="SSTJ_ZT">
	        	<isEqual property="SSTJ_ZT" compareValue="YT">
        			and box.is_yt = 'Y'
	        		<!-- and (select ss.schedule_status from tab_order_box_schedule ss,dict_area d1 where ss.box_id=box.box_id and ss.to = d1.code and ss.command='1' and ss.schedule_status = '2'  order by ss.create_time desc limit 1 ) ='1' -->
	        	</isEqual>
				<isEqual property="SSTJ_ZT" compareValue="YS">
	        		and box.is_ys = 'Y'
	        		<!-- and (select ss.schedule_status from tab_order_box_schedule ss,dict_area d1 where ss.box_id=box.box_id and ss.to = d1.code and ss.command='2' and ss.schedule_status = '2'  order by ss.create_time desc limit 1 ) ='1' -->
	        	</isEqual>
	        	<isEqual property="SSTJ_ZT" compareValue="YH">
	        		and box.is_yh = 'Y'
	        		<!-- and (select ss.schedule_status from tab_order_box_schedule ss,dict_area d1 where ss.box_id=box.box_id and ss.to = d1.code and ss.command='3' and ss.schedule_status = '2'  order by ss.create_time desc limit 1 ) ='1' -->
	        	</isEqual>
	        	<isEqual property="SSTJ_ZT" compareValue="YZX">
	        		and s.schedule_status = '2'
	        	</isEqual>
	        	<isEqual property="SSTJ_ZT" compareValue="ZXZ">
	        		and s.schedule_status = '1'
	        	</isEqual>
	        	<isEqual property="SSTJ_ZT" compareValue="WZX">
	        		and (s.schedule_status = '0' or box.schedule_id is null or box.schedule_id = '')
	        	</isEqual>
	        	<isEqual property="SSTJ_ZT" compareValue="DR">
	        		and date_format(box.create_time,'%Y-%m-%d') = date(now())
	        	</isEqual>
	        	<isEqual property="SSTJ_ZT" compareValue="CR">
	        		and date_format(box.create_time,'%Y-%m-%d') = date_sub(curdate(),interval 1 day)
	        	</isEqual>
	        	<isEqual property="SSTJ_ZT" compareValue="BZ">
	        		and YEARWEEK(date_format(box.create_time,'%Y-%m-%d')) = YEARWEEK(now())
	        	</isEqual>
	        	<isEqual property="SSTJ_ZT" compareValue="YC">
	        		and s.yichang = '1'
	        	</isEqual> 
			</isNotEmpty>
			
			<isNotEmpty property="PCSJ">
				and s.send_time like '%${PCSJ}%' 
			</isNotEmpty>
			
			
			<isNotEmpty property="WNSS">
				and (box.keyword like '%${WNSS}%' or o.keyword like '%${WNSS}%' or s.keyword like '%${WNSS}%') 
			</isNotEmpty>
			
			order by box.create_time desc,o.create_time DESC) a,(select   @i:=0)   as   it 
		</sql>
	</mapper>
	<!-- 获取调度详情信息 -->
	<mapper id="scheduleDetaile">
	    <sql key="scheduleDetaile" resultType="map" operator="select">
	        select o.order_id,box.box_id,(select iout.text from dict_common iout where o.in_out=iout.code and iout.type='INOTYPE') in_out,box.box_remark,
			box.xunzheng,box.shangjian,box.jigui,box.pangui,box.schedule_remark,box.book_send_date,o.ship_date,o.ship_name,o.ship_voyage,o.order_no,box.no,box.seal_no,box.size,box.spec,o.box_ownner_1,o.box_ownner_2,tbo.shortcut, <!-- 箱主显示英文代码 -->
			(select da.name from dict_area da where da.code=o.box_take LIMIT 0,1) box_take,
			(select da.id from dict_area da where da.code = o.box_take limit 0,1) box_take_area_id,
			(select da.name from dict_area da where da.code=o.box_return LIMIT 0,1) box_return,
			(select IF(tp.port_cn='',tp.port_en,tp.port_cn) name from tab_port tp where tp.port_code=o.load_port LIMIT 0,1) load_port,
			(select IF(tp.port_cn='',tp.port_en,tp.port_cn) name from tab_port tp where tp.port_code=o.to_port LIMIT 0,1) to_port,
			(select bat.full_text name from base_area_tab bat where bat.code=o.box_drag_area LIMIT 0,1) box_drag_area,
			(select da.name from dict_area da where da.code=o.box_drag LIMIT 0,1) box_drag,
			tco.company cargo_ownner,o.ownner_name,o.ownner_tel,o.addr,o.shipment_no,
			(select dc.text from dict_common dc where dc.type = 'LOADWAY' and dc.code=o.load_way LIMIT 0,1)  load_way,
			o.order_remark 
			from tab_order o 
			left join tab_box_ownner tbo on o.box_ownner_1 = tbo.ownner_id 
			left join tab_cargo_ownner tco on tco.ownner_id = o.cargo_owner_id
			left join tab_order_box box on o.order_id = box.order_id where box.is_del='N' and box.box_id='${box_id}'
	    </sql>
	    
	     <sql key="scheduleListByBoxid" resultType="list" operator="select">
	        select (select dc.text from dict_common dc where dc.code=s.command and dc.type='SCHEDULENAME') command,s.schedule_id,s.schedule_status,
	        (select da.name from dict_area da where da.code=s.to limit 1) toname,
	        (select da.name from dict_area da where da.code=s.from limit 1) fromname,s.driver,s.truck_plate,s.truck_frame,s.send_time
	        from tab_order_box_schedule s  where s.box_id='${box_id}' and s.is_del='N' order by create_time desc
	    </sql>
	    
	</mapper>
	
	<!-- 修改箱子 -->
	<mapper id="editBoxSchedule">
		  <sql key="editBoxSchedule" operator="execute">
		  	
		  	update tab_order_box set no=#{NO},size=#{SIZE},spec=#{SPEC},seal_no=#{SEAL_NO},book_send_date=#{BOOK_SEND_DATE},
		  	schedule_remark=#{SCHEDULE_REMARK},box_remark=#{BOX_REMARK}
		  	where box_id=#{BOX_ID}
		  	
		  </sql>
		
	</mapper>
	
	<!-- 删除调度 -->
	<mapper id="deleteSchedule">
		  <sql key="deleteSchedule" operator="execute">
		  	update tab_order_box_schedule set is_del='Y'
		  	where schedule_id=#{id}
		  </sql>
		
	</mapper>
	
	<!-- 根据箱子ID获取调度列表 -->
	<mapper id="getSchedulelistByBoxId">
		  <sql key="getSchedulelistByBoxId"  resultType="list" operator="select">
		  	<!--  select (@i:=@i+1) num, (select dc.text from dict_common dc where dc.code=s.command and dc.type='SCHEDULENAME') command,s.schedule_id,s.schedule_status,
	        (select da.name from dict_area da where da.code=s.to) toname,
	        (select da.name from dict_area da where da.code=s.from) fromname,s.driver,s.truck_plate,s.truck_frame,s.send_time
	        from tab_order_box_schedule s  where s.box_id='${box_id}' and s.is_del='N' order by create_time desc -->
		    select (@i:=@i+1) num, (select dc.text from dict_common dc where dc.code=s.command and dc.type='SCHEDULENAME') command,s.schedule_id,s.schedule_status,
	        s.to toname,s.from fromname,s.driver_id,s.driver,s.truck_plate,s.truck_frame,s.send_time,s.schedule_no
	        from tab_order_box_schedule s  where s.box_id='${box_id}' and s.is_del='N' order by create_time desc
		  	
		  </sql>
		
	</mapper>
		
	<!-- 根据箱子ID获取箱子详情 -->
	<mapper id="getBoxByBoxId">
		  <sql key="getBoxByBoxId"  resultType="map" operator="select">
		  	SELECT * FROM tab_order_box where box_id='${box_id}'
		  </sql>
		
	</mapper>
	
	<!-- 判断铅封号是否存在 -->
	<mapper id="checkQfhByBoxId">
		  <sql key="checkQfhByBoxId"  resultType="map" operator="select">
		  	SELECT count(1) num FROM tab_order_box where seal_no='${seal_no}' and box_id != #{box_id}
		  </sql>
	</mapper>
	<!-- 判断是否为双拖 -->
	<mapper id="checkIsShuangTuo">
		<sql key="checkIsShuangTuo" resultType="map" operator="select">
			select s.shuangtuo,s.shuangtuo_box_id,box.no
				from tab_order_box_schedule s 
			left join tab_order_box box on box.box_id = s.shuangtuo_box_id
			where s.schedule_id = #{scheduleId} and s.is_del = 'N' 
		</sql>
	</mapper>
	<!-- 获取双拖箱子的调度信息 -->
	<mapper id="getSTScheduleInfo">
		<sql key="" resultType="map" operator="select">
			SELECT
				a.order_id,a.command,a.order_id,a.box_drag,a.load_port,a.box_take
			FROM
				(
					SELECT
						box.box_id,box.order_id,GROUP_CONCAT(s.command) command,d_drag.`name` box_drag,d_port.`name` load_port,d_take.`name` box_take
					FROM
						`tab_order_box_schedule` s
					LEFT JOIN tab_order_box box ON box.box_id = s.box_id AND box.is_del = 'N'
					LEFT JOIN tab_order o ON o.order_id = box.order_id
					LEFT JOIN dict_area d_drag ON d_drag.`code` = o.box_drag
					LEFT JOIN dict_area d_port ON d_port.`code` = o.load_port
					LEFT JOIN dict_area d_take ON d_take.`code` = o.box_take
					WHERE
						1 = 1 
					AND s.is_del = 'N'
					AND s.schedule_status != 2
					<isNotEmpty property="st_box_id">
						AND box.box_id = #{st_box_id}
					</isNotEmpty>
				) a
		</sql>
	</mapper>
	<!-- 获取箱子最后调度信息的起点、终点 -->
	<mapper id="getSTArea">
		<sql key="getSTArea" resultType="map" operator="select">
			SELECT
				schedule_id,`from`,from_lat,from_lng,`to`,to_lat,to_lng
			FROM
				tab_order_box_schedule x
			WHERE
				1=1
			<isNotEmpty property="st_box_id">
				AND x.box_id = #{st_box_id}
			</isNotEmpty>
			AND x.schedule_status != 2
			AND x.is_del = 'N'
			ORDER BY
				x.create_time
			LIMIT 0,
			 1
		</sql>
	</mapper>
	<!-- 获取车辆最后一条调度信息 -->
	<mapper id="getTruckLastScheduele">
		<sql key="getTruckLastScheduele" operator="select" resultType="map">
			SELECT
				s.`from`, s.from_lng, s.from_lat,
				s.`to`, s.to_lng, s.to_lat,
				s.create_time
			FROM
				tab_order_box_schedule s
			WHERE
				1 = 1
			AND s.truck_id = #{truck_id}
			ORDER BY 
				s.create_time DESC
			LIMIT 1
		</sql>
	</mapper>
	<!-- 调度预约操作 -->
	<mapper id="toScheduleReserve">
		<sql key="toScheduleReserve" operator="execute">
			UPDATE tab_order_box T
			   SET T.IS_RESERVE = ${IS_RESERVE}, T.RESERVE_TIME = NOW(),T.RESERVE_USERID='$_CRU_USER_ID_$'
			 WHERE T.BOX_ID = #{BOX_ID} LIMIT 1
		</sql>
	</mapper>
	<!-- 获取箱子的提箱地点 -->
	<mapper id="getBoxTakeArea">
		<sql key="getBoxTakeArea" operator="select" resultType="map">
			select da.name addr_tx from tab_order_box t 
			left join dict_area da on da.code = t.addr_tx
			where t.box_id = #{box_id}
		</sql>
	</mapper>
</mappers>