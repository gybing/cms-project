<?xml version="1.0" encoding="UTF-8"?>
<mappers xmlns="http://www.weimingfj.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://itest.56913.com:20080/xsd/mappers.xsd">
	
	<!-- 车辆车架列表 -->
	<mapper id="queryFrameList">
	    <sql key="queryFrameList" resultType="paging" operator="select">
	        SELECT
	        <isNotEmpty property="query_count">
				count(FT_ID)
			</isNotEmpty>
			<isEmpty property="query_count">
				(@i:=@i+1) seq,A.* from 
	      	( select a.*
			</isEmpty>
			FROM(
			SELECT
				kt.FT_ID,
				kt. CODE,
				kt.TRUCK_PLATE,
				kt.TRUCK_TYPE,
				IFNULL(td.`name`,'') AS DEFAULT_DRIVER,
				IFNULL(tft.CODE,'') AS DEFAULT_FRAME,
				(CASE kt.TYPE WHEN 'F' THEN '车架' WHEN 'T' THEN '车辆' END) AS type,
				IFNULL((CASE kt.`status` WHEN 'N' THEN '正常' WHEN 'D' THEN '非正常' END),'') AS `STATUS`,
				IFNULL(kt.REMARK,'') AS REMARK,
				kt.REGISTER_DATE
			FROM
				tab_frame_truck kt 
			LEFT JOIN tab_driver td ON kt.default_driver_id=td.driver_id
			LEFT JOIN tab_frame_truck tft ON kt.default_frame_id=tft.ft_id
			WHERE
				kt.tag=(select TAG from user_tab where USER_ID = '$_CRU_USER_ID_$') 
				AND kt.is_del='N' 
			<isNotEmpty property="columns[0][search][value]">
				AND kt.search_field LIKE '%${columns[0][search][value]}%'
			</isNotEmpty>
			<isNotEmpty property="columns[1][search][value]">
				AND kt.type= '${columns[1][search][value]}'
			</isNotEmpty>
			)a 
			<isEmpty property="query_count">
				<isNotEmpty property="sortname">
					order by ${sortname} ${sortorder}
				</isNotEmpty>
				<isEmpty property="sortname">
					ORDER BY
						a.CODE DESC 
				</isEmpty>
				limit ${page_start}, ${page_end}
				) A,(SELECT @i:= ${page_start} ) it
			</isEmpty>
	    </sql>
	</mapper>
	
	<!-- 删除车辆车架 -->
	<mapper id="delFrame">
	    <sql key="delFrame" operator="execute">
	    	UPDATE tab_frame_truck SET is_del='Y' where ft_id = #{delFrameId}
		</sql>
		<sql key="delFrame" operator="execute">
	    	DELETE FROM tab_truck_status where ft_id = #{delFrameId}
		</sql>
	</mapper>
	
	<!-- 据id查询车辆车架详情 -->
	<mapper id="queryFrameInfoById">
	    <sql key="queryFrameInfoById" resultType="map" operator="select">
	    SELECT
			ts.*,
			tft.code AS FRAMECODE
		FROM
			tab_frame_truck AS ts
		LEFT JOIN tab_frame_truck tft ON ts.default_frame_id=tft.ft_id 
		WHERE
			ts.ft_id = #{editFrameId}
		</sql>
	</mapper>
	
	<!-- 获取相应车辆车架图片 -->
	<mapper id="queryFramePicById">
		<sql key="queryFramePicById" resultType="list" operator="select">
			SELECT
				tftp.*,
				dc.text
			FROM
				tab_frame_truck_pic tftp
			LEFT JOIN dict_common dc ON tftp.pic_type=dc.`code`
			WHERE
				tftp.ft_id = #{ftId} 
			AND tftp.is_del='N'
		</sql>
	</mapper>
	
	<!-- 查询车架信息 -->
	<mapper id="queryFrame">
		<sql key="queryFrame" resultType="list" operator="select">
			SELECT
				ts.ft_id,ts.code,ts.truck_plate
			FROM
				tab_frame_truck AS ts
			WHERE
				ts.is_del='N' 
			AND ts.type='F' 
			AND ts.tag=(select TAG from user_tab where USER_ID = '$_CRU_USER_ID_$') 
		</sql>
	</mapper>
</mappers>